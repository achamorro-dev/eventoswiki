---
import { EventEditForm } from '@/events/presentation/client/components/event-edit-form/event-edit-form'
import BaseLayout from '@/layouts/base-layout.astro'
import Layout from '@/layouts/layout.astro'
import { OrganizationsContainer } from '@/organizations/di/organizations.container'
import { GetOrganizationQuery } from '@/organizations/application/get-organization.query'
import { OrganizationNotFound } from '@/organizations/domain/errors/organization-not-found.error'
import { ProvincesContainer } from '@/provinces/di/provinces.container'
import type { Province } from '@/provinces/domain/province'
import NotFound from '@/ui/components/not-found/not-found.astro'
import { SectionTitle } from '@/ui/components/section-title/section-title'
import { Urls } from '@/ui/urls/urls'
import { GetProvincesQuery } from '@/provinces/application/get-provinces.query'

const { handle } = Astro.params
const userId = Astro.locals.user?.id

if (!handle) {
  return Astro.redirect(Urls.HOME)
}

let organization
let provinces: Province[] = []
try {
  const getProvincesQuery = ProvincesContainer.get(GetProvincesQuery)
  ;[organization, provinces] = await Promise.all([
    OrganizationsContainer.get(GetOrganizationQuery).execute({ handle: handle }),
    getProvincesQuery.execute(),
  ])

  if (!userId || !organization.isOrganizer(userId)) {
    return Astro.redirect(Urls.ORGANIZATION(organization.handle))
  }
} catch (error) {
  switch (true) {
    case error instanceof OrganizationNotFound:
      Astro.response.status = 404
      Astro.response.statusText = 'Not found'
      break
    default:
      Astro.response.status = 500
      Astro.response.statusText = 'Internal server error'
      break
  }
}
---

{
  organization ? (
    <Layout title={'Crear evento'}>
      <article>
        <SectionTitle>Crear evento</SectionTitle>
        <EventEditForm
          client:only="react"
          organizationId={organization.id.value}
          organization={organization.toPrimitives()}
          provinces={provinces}
        />
      </article>
    </Layout>
  ) : (
    <BaseLayout title="Organización no encontrada">
      <NotFound title="Organización no encontrada" />
    </BaseLayout>
  )
}
