---
import CalendarContent from '@/modules/shared/presentation/server/components/calendar/calendar.astro'
import ProvinceComboboxFilter from '@/provinces/presentation/server/components/province-combobox/province-combobox-filter.astro'
import { Datetime } from '@/shared/domain/datetime/datetime'
import { EventType } from '@/shared/domain/types/event-type'
import { EventTypeFilter } from '@/ui/components/event-type-filter/event-type-filter'
import AuthOverlay from '@/shared/presentation/ui/components/auth-overlay/auth-overlay.astro'
import SearchFiltersBar from '@/ui/components/search-filters-bar/search-filters-bar.astro'
import { SectionTitle } from '@/ui/components/section-title/section-title'
import { Loader } from '@/ui/icons'
import Layout from '../layouts/layout.astro'

const url = new URL(Astro.request.url)
const date = url.searchParams.get('date')
const province = url.searchParams.get('province') || undefined
const eventType = (url.searchParams.get('type') as EventType | undefined) || EventType.EVENTS

const selectedDate = date ? Datetime.toDate(date) : Datetime.now()
const nextMonth = Datetime.add(selectedDate, 1, 'month')
const previousMonth = Datetime.subtract(selectedDate, 1, 'month')

// Authentication check for date restrictions
const isAuthenticated = Astro.locals.user !== null
const isCurrentMonth = Datetime.isSameMonth(selectedDate, Datetime.now())
const needsAuthOverlay = !isAuthenticated && !isCurrentMonth

// Create search params for prefetch links
const createCalendarSearchParams = (targetDate: Date) => {
  const params = new URLSearchParams()
  params.set('date', Datetime.toDateIsoString(targetDate))
  if (province) params.set('province', province)
  if (eventType) params.set('type', eventType)
  return params.toString()
}

const nextMonthParams = createCalendarSearchParams(nextMonth)
const previousMonthParams = createCalendarSearchParams(previousMonth)
---

<Layout
  title="eventos.wiki - Calendario"
  description="En eventos.wiki encontrarás el calendario de eventos sobre desarrollo y tecnología definitivo. Pasa y echa un vistazo a la gran variedad de eventos y, si falta el tuyo, sólo tienes que pedírnoslo."
>
  <!-- Hidden prefetch links for next and previous month -->
  <a href={`/calendar?${nextMonthParams}`} rel="prefetch" class="hidden"></a>
  <a href={`/calendar?${previousMonthParams}`} rel="prefetch" class="hidden"></a>

  <SectionTitle>Calendario</SectionTitle>
  <SearchFiltersBar>
    <EventTypeFilter client:only value={eventType} />
  </SearchFiltersBar>
  <div class="flex justify-start gap-2 mb-4">
    <ProvinceComboboxFilter server:defer value={province} />
  </div>
  <article class="mt-4">
    {
      needsAuthOverlay ? (
        <AuthOverlay 
          redirectUrl={Astro.url.pathname + Astro.url.search}
          message="¡Sigue descubriendo todos los eventos del calendario!"
        />
      ) : (
        <CalendarContent server:defer selectedDate={selectedDate} province={province} eventType={eventType}>
          <div slot="fallback" class="grid h-96 place-content-center">
            <Loader className="text-primary size-10 animate-spin" />
          </div>
        </CalendarContent>
      )
    }
  </article>
</Layout>
