---
import NextEventsGrid from '@/events/presentation/server/components/next-events/next-events-grid.astro'
import AuthOverlay from '@/shared/presentation/ui/components/auth-overlay/auth-overlay.astro'
import Layout from '@/layouts/layout.astro'
import ProvinceComboboxFilter from '@/provinces/presentation/server/components/province-combobox/province-combobox-filter.astro'
import EventsGridSkeleton from '@/ui/components/events-grid/events-grid-skeleton.astro'
import EventsHeader from '@/ui/components/events-header/events-header.astro'
import SearchFiltersBar from '@/ui/components/search-filters-bar/search-filters-bar.astro'
import { Urls } from '@/ui/urls/urls'

const searchParams = new URL(Astro.request.url).searchParams
const page = searchParams.get('page') ? Number(searchParams.get('page')) : 1
const province = searchParams.get('province') || undefined

// Authentication check for pagination
const isAuthenticated = Astro.locals.user !== null
const needsAuthOverlay = !isAuthenticated && page > 1
---

<Layout title="eventos.wiki - Eventos">
  <EventsHeader title="Eventos" actionLink={Urls.PAST_EVENTS} actionText="Ver pasados" transition:persist>
    <SearchFiltersBar>
      <ProvinceComboboxFilter value={province} />
    </SearchFiltersBar>
  </EventsHeader>

  {
    needsAuthOverlay ? (
      <AuthOverlay 
        redirectUrl={Astro.url.pathname + Astro.url.search}
        message="Â¡Sigue explorando todos los eventos!"
      />
    ) : (
      <NextEventsGrid location={province} page={page} server:defer>
        <EventsGridSkeleton slot="fallback" />
      </NextEventsGrid>
    )
  }
</Layout>
