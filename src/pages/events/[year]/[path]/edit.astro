---
import { navigate } from 'astro:transitions/client'
import { EventsContainer } from '@/events/di/events.container'
import { GetEventQuery } from '@/events/application/get-event.query'
import { EventNotFound } from '@/events/domain/errors/event-not-found'
import type { Event } from '@/events/domain/event'
import { EventEditTabs } from '@/events/presentation/client/components/event-edit-tabs/event-edit-tabs'
import BaseLayout from '@/layouts/base-layout.astro'
import Layout from '@/layouts/layout.astro'
import { OrganizationsContainer } from '@/organizations/di/organizations.container'
import { GetUserOrganizationsQuery } from '@/organizations/application/get-user-organizations.query'
import type { Organization } from '@/organizations/domain/organization'
import { ProvincesContainer } from '@/provinces/di/provinces.container'
import type { Province } from '@/provinces/domain/province'
import NotFound from '@/ui/components/not-found/not-found.astro'
import { SectionTitle } from '@/ui/components/section-title/section-title'
import { Urls } from '@/ui/urls/urls'
import { GetProvincesQuery } from '@/provinces/application/get-provinces.query'

const year = Astro.params.year
const path = Astro.params.path

if (!year || !path) {
  navigate(Urls.HOME)
  return
}

const userId = Astro.locals.user?.id
const slug = `${year}/${path}`

let event: Event | undefined
let provinces: Province[] = []
let organization: Organization | undefined
let canEdit = false

try {
  event = await EventsContainer.get(GetEventQuery).execute({ slug: slug })
  const getProvincesQuery = ProvincesContainer.get(GetProvincesQuery)
  provinces = await getProvincesQuery.execute()

  if (!event.hasOrganization()) {
    return Astro.redirect(Urls.EVENT(slug))
  }

  if (event && userId) {
    const organizations = await OrganizationsContainer.get(GetUserOrganizationsQuery).execute({ userId })
    organization = organizations.find(org => event!.isOrganizedBy(org.id))
    canEdit = organization !== undefined
  }
} catch (error) {
  switch (true) {
    case error instanceof EventNotFound:
      Astro.response.status = 404
      Astro.response.statusText = 'Not found'
      break
    default:
      Astro.response.status = 500
      Astro.response.statusText = 'Internal server error'
      break
  }
}
---

{
  event && organization && canEdit ? (
    <>
      <Layout title={'Editar evento'}>
        <article>
          <SectionTitle>Editar evento</SectionTitle>
          <EventEditTabs
            client:only="react"
            event={event.toPrimitives()}
            provinces={provinces}
            organization={organization.toPrimitives()}
          />
        </article>
      </Layout>
    </>
  ) : (
    <BaseLayout title="Evento no encontrado">
      <NotFound title="Evento no encontrado" />
    </BaseLayout>
  )
}
