---
import { EventsLocator } from '@/events/di/events.locator'
import { MeetupsLocator } from '@/meetups/di/meetups.locator'
import { Meetup } from '@/meetups/domain/meetup'
import AttendMeetupSection from '@/meetups/presentation/server/components/attend-meetup-section/attend-meetup-section.astro'
import { EventAttendeesRow } from '@/shared/presentation/ui/components/event-attendees-row/event-attendees-row'
import { Event } from '@/modules/events/domain/event'
import { EventDatePeriod } from '@/ui/components/event-date-period/event-date-period'
import { EventLocation } from '@/ui/components/event-location/event-location'
import { EventStreaming } from '@/ui/components/event-streaming/event-streaming'
import EventTags from '@/ui/components/event-tags/event-tags.astro'
import { EventTypeDisplay } from '../event-type-display/event-type-display'

interface Props {
  id: string
  type: 'event' | 'meetup'
  isOrganizer: boolean
}

const { id, type: entityType, isOrganizer } = Astro.props
const userId = Astro.locals.user?.id

let event: Event | Meetup | null = null
let isAttending = false
try {
  if (entityType === 'event') {
    event = await EventsLocator.findEventQuery().execute({ id })
  } else {
    event = await MeetupsLocator.findMeetupQuery().execute({ id })
    if (event instanceof Meetup && userId) {
      isAttending = event.isAttending(userId)
    }
  }
} catch (error) {
  // Handle error - event not found
  event = null
}

if (!event) {
  return null
}

const { title, tags, tagColor, startsAt, endsAt, location, type } = event
const streamingUrl = event.streamingUrl
const shouldShowStreamingLink = isOrganizer || isAttending
const place = event.place?.toPrimitives()

// Get attendees data for meetups that allow attendees
let initialAttendees: Array<{name: string; avatar?: string | null}> = []
if (event instanceof Meetup && event.allowsAttendees && event.hasAttendees()) {
    try {
      const attendees = await MeetupsLocator.findMeetupAttendeesQuery().execute(event.id.value)
      initialAttendees = attendees.map(attendee => attendee.toPrimitives())
    } catch (error) {
      // Silently fail if we can't fetch attendees
  }
}
---

<div class="w-full lg:px-6 max-w-5xl xl:px-0">
  <EventTags tags={tags} tagColor={tagColor} />
  <h1 class="text-4xl font-medium text-black dark:text-white" tabindex={0} transition:animate="fade">
    {title}
  </h1>
  <EventDatePeriod startDate={startsAt} endDate={endsAt} client:load transition:animate="fade" />
  <EventTypeDisplay type={type} client:load transition:animate="fade" />
  {
    event instanceof Meetup && event.hasAttendees() && (
      <EventAttendeesRow
        client:load
        attendees={initialAttendees}
        transition:animate="fade"
      />
    )
  }
  <EventLocation location={location} place={place} client:load transition:animate="fade" />
  <EventStreaming
    streamingUrl={streamingUrl}
    shouldShowLink={shouldShowStreamingLink}
    client:load
    transition:animate="fade"
  />
  {event instanceof Meetup && !isOrganizer && <AttendMeetupSection meetup={event} isAttending={isAttending} />}
</div>
