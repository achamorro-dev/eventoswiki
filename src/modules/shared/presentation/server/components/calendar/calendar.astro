---
import { EventsContainer } from '@/events/di/events.container'
import { FindEventsQuery } from '@/events/application/find-events.query'
import { Event } from '@/events/domain/event'
import { FindMeetupsQuery } from '@/meetups/application/find-meetups.query'
import { MeetupsContainer } from '@/meetups/di/meetups.container'
import { Meetup } from '@/meetups/domain/meetup'
import { Datetime } from '@/shared/domain/datetime/datetime'
import { EventType } from '@/shared/domain/types/event-type'
import { Agenda } from '@/ui/components/big-calendar/agenda'
import { BigCalendar } from '@/ui/components/big-calendar/big-calendar'
import type { CalendarEvent } from '@/ui/components/big-calendar/calendar-event'
import { Urls } from '@/ui/urls/urls'

interface Props {
  selectedDate: Date
  eventType: EventType
  province?: string
}

const { selectedDate, province, eventType } = Astro.props as Props

const startsAt = Datetime.getFirstMondayOfMonthWeek(selectedDate)
const endsAt = Datetime.getLastSundayOfMonth(selectedDate)
let filteredEvents: Event[] = []
let filteredMeetups: Meetup[] = []

if (eventType === EventType.EVENTS) {
  const paginatedEvents = await EventsContainer.get(FindEventsQuery).execute({ startsAt, endsAt, province, limit: 1000 })
  filteredEvents = paginatedEvents.data
}

if (eventType === EventType.MEETUPS) {
  const paginatedMeetups = await MeetupsContainer.get(FindMeetupsQuery).execute({ startsAt, endsAt, province, limit: 1000 })
  filteredMeetups = paginatedMeetups.data
}

const calendarEvents = (filteredEvents as Array<Meetup | Event>).concat(filteredMeetups).map<CalendarEvent>((event: Meetup | Event, index) => {
  const isMeetup = event instanceof Meetup
  return {
    id: index,
    title: event.title,
    start: event.startsAt,
    end: event.endsAt,
    url: isMeetup ? Urls.MEETUP(event.slug) : Urls.EVENT(event.slug),
    color: event.tagColor,
  } as CalendarEvent
})
---

<Agenda client:load events={calendarEvents} selectedDate={selectedDate} className="block md:hidden" />
<BigCalendar client:load events={calendarEvents} selectedDate={selectedDate} className="hidden md:block" />
