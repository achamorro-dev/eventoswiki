---
import { Agenda } from '@/events/domain/agenda/agenda'
import { Datetime } from '@/shared/domain/datetime/datetime'

interface Props {
  agenda: Agenda
}

const { agenda } = Astro.props

const hasContent = agenda.hasContent()
const hasTracks = agenda.hasTracks()
const hasCommonElements = agenda.hasCommonElements()

// Get all unique dates from sessions and common elements
const allDates = new Set<string>()

if (hasCommonElements) {
  agenda.getCommonElements().forEach(element => {
    allDates.add(Datetime.toDateIsoString(element.getStartsAt()))
  })
}

if (hasTracks) {
  agenda.getTracks().forEach(track => {
    track.getSessions().forEach(session => {
      allDates.add(Datetime.toDateIsoString(session.getStartsAt()))
    })
  })
}

const sortedDates = Array.from(allDates).sort()
---

<section class="agenda-section space-y-8">
  {!hasContent && (
    <div class="text-muted-foreground text-center">
      No hay informaci√≥n de agenda disponible para este evento.
    </div>
  )}

  {hasContent && (
    <>
      <!-- Date Navigation -->
      {sortedDates.length > 1 && (
        <div class="flex flex-wrap gap-2 justify-center">
          {sortedDates.map(date => (
            <a
              href={`#${date}`}
              class="inline-flex items-center rounded-md border border-input bg-background px-3 py-1 text-sm hover:bg-accent hover:text-accent-foreground"
            >
              {new Date(date).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </a>
          ))}
        </div>
      )}

      <!-- Agenda by Date -->
      {sortedDates.map(date => {
        // Get common elements for this date
        const commonElementsForDate = agenda.getCommonElements().filter(element =>
          Datetime.toDateIsoString(element.getStartsAt()) === date
        )

        // Get tracks with sessions for this date
        const tracksWithSessions = agenda.getTracks()
          .map(track => ({
            track,
            sessions: track.getSessionsByDate(new Date(date)),
          }))
          .filter(({ sessions }) => sessions.length > 0)

        return (
          <div id={date} class="space-y-6 scroll-mt-20">
            <h2 class="font-bold text-2xl">
              {new Date(date).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </h2>

            <!-- Common Elements (full width) -->
            {commonElementsForDate.length > 0 && (
              <div class="space-y-3">
                {commonElementsForDate.map(element => (
                  <div class="rounded-lg bg-muted/50 p-4">
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <div class="mb-2 flex items-center gap-2 flex-wrap">
                          <span class="rounded-full bg-primary/10 px-2 py-0.5 text-sm font-medium">
                            {element.getType().replace('-', ' ').toUpperCase()}
                          </span>
                          <span class="text-muted-foreground text-sm">
                            {element.getFormattedStartTime()} - {element.getFormattedEndTime()}
                          </span>
                        </div>
                        <h3 class="font-semibold text-lg">{element.getTitle()}</h3>
                        {element.getDescription() && (
                          <p class="text-muted-foreground mt-1">{element.getDescription()}</p>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <!-- Tracks Grid -->
            {tracksWithSessions.length > 0 && (
              <div class={`grid gap-6 ${tracksWithSessions.length === 1 ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2'}`}>
                {tracksWithSessions.map(({ track, sessions }) => (
                  <div class="space-y-3">
                    <div class="border-b pb-2">
                      <h3 class="font-semibold text-xl">{track.getName()}</h3>
                      {track.hasDescription() && (
                        <p class="text-muted-foreground text-sm">{track.getDescription()}</p>
                      )}
                    </div>

                    <div class="space-y-3">
                      {sessions.map(session => (
                        <div class="rounded-lg border p-4">
                          <div class="mb-2 flex items-center gap-2 flex-wrap">
                            <span class="text-muted-foreground text-sm font-medium">
                              {session.getFormattedStartTime()} - {session.getFormattedEndTime()}
                            </span>
                            {session.getLanguage() && (
                              <span class="rounded bg-secondary px-2 py-0.5 text-xs">
                                {session.getLanguage()?.toUpperCase()}
                              </span>
                            )}
                          </div>

                          <h4 class="font-semibold text-lg">{session.getTitle()}</h4>

                          {session.hasCategories() && (
                            <div class="mt-2 flex flex-wrap gap-1">
                              {session.getCategories()?.map(category => (
                                <span class="rounded-full bg-accent px-2 py-0.5 text-xs">
                                  {category}
                                </span>
                              ))}
                            </div>
                          )}

                          {session.hasSpeakers() && (
                            <div class="mt-3 flex items-center gap-2">
                              {session.getSpeakers().map(speaker => (
                                <div class="flex items-center gap-2">
                                  {speaker.hasImage() && (
                                    <img
                                      src={speaker.getImage()!}
                                      alt={speaker.getName()}
                                      class="h-8 w-8 rounded-full object-cover"
                                    />
                                  )}
                                  <span class="text-sm">{speaker.getName()}</span>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )
      })}
    </>
  )}
</section>

<style>
  .agenda-section {
    min-height: 200px;
  }
</style>
