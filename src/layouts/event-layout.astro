---
import { Event } from '@/modules/events/domain/event'
import BaseLayout from './base-layout.astro'
import AddToCalendarButton from '@/ui/components/add-to-calendar-button/add-to-calendar-button.astro'
import Container from '@/ui/components/container/container.astro'
import { Link as LinkIcon, Pencil } from '@/ui/icons'
import { Urls } from '@/ui/urls/urls'
import { Meetup } from '@/meetups/domain/meetup'
import { SocialRow } from '@/ui/components/social-row/social-row'
import { Link } from '@/ui/components/link'
import OrganizedBy from '@/organizations/presentation/server/components/organized-by/organized-by.astro'
import { DeleteEventModal } from '@/events/presentation/client/components/delete-event-modal/delete-event-modal'
import { DeleteMeetupModal } from '@/meetups/presentation/client/components/delete-meetup-modal/delete-meetup-modal'
import EventHeaderInfo from '@/ui/components/event-header-info/event-header-info.astro'

interface Props {
  event: Event | Meetup
  isOrganizer?: boolean
}
const { event, isOrganizer = false } = Astro.props

const {
  slug,
  title,
  shortDescription,
  image,
  tags,
  tagColor,
  startsAt,
  endsAt,
  twitter,
  twitch,
  instagram,
  youtube,
  facebook,
  linkedin,
  github,
  telegram,
  whatsapp,
  discord,
  web,
  location,
  organizationId,
} = event
const streamingUrl = event instanceof Meetup ? event.streamingUrl : undefined
const url = event instanceof Meetup ? Urls.MEETUP(slug) : Urls.EVENT(slug)
---

<BaseLayout
  title={`${title} - eventos.wiki`}
  description={shortDescription}
  image={image.toString()}
  url={`https://eventos.wiki${url}`}
>
  <header
    class="max-w-5xl w-full mx-auto mt-4 flex flex-col justify-center lg:items-start px-4 lg:px-0 lg:justify-start gap-4 md:flex-row"
    id="main"
  >
    <div class="flex flex-col items-center gap-4">
      <img
        id="event-image"
        src={image.toString()}
        alt={`Foto de portada del evento ${title}`}
        class="w-full md:max-w-[800px] md:max-h-[400px] min-h-[200px] min-w-[300px] object-cover rounded-xl shadow-md bg-white"
        loading="lazy"
        onerror="this.src='/not-found.jpg'"
        transition:name={`media-image-${url}`}
      />
      <OrganizedBy organizationId={organizationId}>
        {
          isOrganizer && (
            <div slot="actions" class="flex flex-row md:flex-col gap-2">
              <Link variant="secondary" href={event instanceof Meetup ? Urls.MEETUP_EDIT(slug) : Urls.EVENT_EDIT(slug)}>
                <Pencil />
                Editar
              </Link>
              {event instanceof Meetup ? (
                <DeleteMeetupModal client:load meetupId={event.id.value} />
              ) : (
                <DeleteEventModal client:load eventId={event.id.value} />
              )}
            </div>
          )
        }
      </OrganizedBy>
      <SocialRow
        name={title}
        twitter={twitter}
        twitch={twitch}
        instagram={instagram}
        youtube={youtube}
        facebook={facebook}
        linkedin={linkedin}
        github={github}
        telegram={telegram}
        whatsapp={whatsapp}
        discord={discord}
        web={web}
      />
    </div>
    <EventHeaderInfo
      id={event.id.value}
      type={event instanceof Meetup ? 'meetup' : 'event'}
      isOrganizer={isOrganizer}
    />
  </header>
  <main class="lg:mt-4">
    <Container maxSize="m" className="event-container content-styles">
      <slot />
    </Container>
    <div class="sticky bottom-2 w-full text-center p-4">
      <AddToCalendarButton
        title={title}
        description={shortDescription}
        startsAt={startsAt}
        endsAt={endsAt}
        location={location || undefined}
      />
    </div>
  </main>
</BaseLayout>

<style is:global>
  @reference "../styles/global.css";

  body {
    @apply bg-background text-foreground dark:bg-background dark:text-foreground m-0 grid min-h-full grid-rows-[auto_auto_1fr_auto] scroll-smooth;
  }

  .event-container a {
    @apply underline;
  }
</style>
